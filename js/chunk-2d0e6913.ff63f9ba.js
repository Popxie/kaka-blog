(window.webpackJsonp=window.webpackJsonp||[]).push([["chunk-2d0e6913"],{"98fd":function(s,t,e){"use strict";e.r(t);var a=e("2877"),r=Object(a.a)({},(function(){var s=this;s.$createElement;return s._self._c,s._m(0)}),[function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("section",[e("html",[e("head"),e("body",[e("h1",[s._v("Git 内部原理之 Git 对象存储")]),e("h2",[s._v("原理")]),e("p",[s._v("数据对象、树对象和提交对象都是存储在"),e("code",{pre:!0},[s._v(".git/objects")]),s._v(" 目录下，目录的结构如下：")]),e("pre",{pre:!0},[e("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[s._v(".git\n|-- objects\n    |-- 01\n    |   |-- 55eb4229851634a0f03eb265b69f5a2d56f341\n    |-- 1f\n    |   |-- 7a7a472abf3dd9643fd615f6da379c4acb3e3a\n    |-- 83\n        |-- baae61804e65cc73a7201a7252750c76066a30\n")])]),e("p",[s._v("从上面的目录结构可以看出，Git 对象的 40 位 "),e("code",{pre:!0},[s._v("hash")]),s._v(" 分为两部分：头两位作为文件夹，后 38 位作为对象文件名。所以一个 "),e("code",{pre:!0},[s._v("Git")]),s._v(" 对象的存储路径规则为：")]),e("pre",{pre:!0},[e("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[s._v(".git/objects/hash[0, 2]/hash[2, 40]\n")])]),e("p",[s._v("这里就产生了一个疑问：为什么 "),e("code",{pre:!0},[s._v("Git")]),s._v(" 要这么设计目录结构，而不直接用 "),e("code",{pre:!0},[s._v("Git")]),s._v(" 对象的 40 位 "),e("code",{pre:!0},[s._v("hash")]),s._v(" 作为文件名？原因是有两点：")]),e("ul",[e("li",[s._v("1.有些文件系统对目录下的文件数量有限制。例如，"),e("code",{pre:!0},[s._v("FAT32")]),s._v(" 限制单目录下的最大文件数量是 65535 个，如果使用 U 盘拷贝 "),e("code",{pre:!0},[s._v("Git")]),s._v(" 文件就可能出现问题。")]),e("li",[s._v("2.有些文件系统访问文件是一个线性查找的过程，目录下的文件越多，访问越慢。")])]),e("p",[s._v("在在 "),e("code",{pre:!0},[s._v("Git")]),s._v(" 内部原理之 "),e("code",{pre:!0},[s._v("Git")]),s._v(" 对象哈希中，我们知道 "),e("code",{pre:!0},[s._v("Git")]),s._v(" 对象会在原内容前加个一个头部：")]),e("pre",{pre:!0},[e("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[s._v("store = header + content\n")])]),e("p",[s._v("Git 对象在存储前，会使用 "),e("code",{pre:!0},[s._v("zlib")]),s._v(" 的 "),e("code",{pre:!0},[s._v("deflate")]),s._v(" 算法进行压缩，即简要描述为：")]),e("pre",{pre:!0},[e("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[s._v("zlib_store = zlib.deflate(store)\n")])]),e("p",[s._v("压缩后的 "),e("code",{pre:!0},[s._v("zlib_store")]),s._v(" 按照 "),e("code",{pre:!0},[s._v("Git")]),s._v(" 对象的路径规则存储到"),e("code",{pre:!0},[s._v(".git/objects")]),s._v(" 目录下。")]),e("p",[s._v("总结下 Git 对象存储的算法步骤：")]),e("ul",[e("li",[s._v("1.计算 "),e("code",{pre:!0},[s._v("content")]),s._v(" 长度，构造 "),e("code",{pre:!0},[s._v("header")]),s._v(" ;")]),e("li",[s._v("2.将 "),e("code",{pre:!0},[s._v("header")]),s._v(" 添加到 "),e("code",{pre:!0},[s._v("content")]),s._v(" 前面，构造 "),e("code",{pre:!0},[s._v("Git")]),s._v(" 对象；")]),e("li",[s._v("3.使用 "),e("code",{pre:!0},[s._v("sha1")]),s._v(" 算法计算 "),e("code",{pre:!0},[s._v("Git")]),s._v(" 对象的 40 位 "),e("code",{pre:!0},[s._v("hash")]),s._v(" 码；")]),e("li",[s._v("4.使用 "),e("code",{pre:!0},[s._v("zlib")]),s._v(" 的 "),e("code",{pre:!0},[s._v("deflate")]),s._v(" 算法压缩 "),e("code",{pre:!0},[s._v("Git")]),s._v(" 对象；")]),e("li",[s._v("5.将压缩后的 "),e("code",{pre:!0},[s._v("Git")]),s._v(" 对象存储到"),e("code",{pre:!0},[s._v(".git/objects/hash[0, 2]/hash[2, 40]")]),s._v("路径下;")])]),e("h2",[s._v("Nodejs 实现")]),e("p",[s._v("接下来，我们使用 "),e("code",{pre:!0},[s._v("Nodejs")]),s._v(" 来实现 "),e("code",{pre:!0},[s._v("git hash-object -w")]),s._v(" 的功能，即计算 Git 对象的 "),e("code",{pre:!0},[s._v("hash")]),s._v(" 值并存储到 Git 文件系统中：")]),e("pre",{pre:!0},[e("code",{pre:!0,attrs:{"v-pre":"",class:"language-js"}},[e("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" fs = "),e("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("require")]),s._v("("),e("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'fs'")]),s._v(")\n"),e("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" crypto = "),e("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("require")]),s._v("("),e("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'crypto'")]),s._v(")\n"),e("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" zlib = "),e("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("require")]),s._v("("),e("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'zlib'")]),s._v(")\n\n"),e("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("function")]),s._v(" "),e("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("gitHashObject")]),s._v("("),e("span",{pre:!0,attrs:{class:"hljs-params"}},[s._v("content, type")]),s._v(") {\n  "),e("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 构造header")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" header = "),e("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("`"),e("span",{pre:!0,attrs:{class:"hljs-subst"}},[s._v("${type}")]),s._v(" "),e("span",{pre:!0,attrs:{class:"hljs-subst"}},[s._v("${Buffer."),e("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("from")]),s._v("(content).length}")]),s._v("\\0`")]),s._v("\n\n  "),e("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 构造Git对象")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" store = "),e("span",{pre:!0,attrs:{class:"hljs-title class_"}},[s._v("Buffer")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("concat")]),s._v("(["),e("span",{pre:!0,attrs:{class:"hljs-title class_"}},[s._v("Buffer")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("from")]),s._v("(header), "),e("span",{pre:!0,attrs:{class:"hljs-title class_"}},[s._v("Buffer")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("from")]),s._v("(content)])\n\n  "),e("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 计算hash")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" sha1 = crypto."),e("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("createHash")]),s._v("("),e("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'sha1'")]),s._v(")\n  sha1."),e("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("update")]),s._v("(store)\n  "),e("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" hash = sha1."),e("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("digest")]),s._v("("),e("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'hex'")]),s._v(")\n\n  "),e("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 压缩Git对象")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" zlib_store = zlib."),e("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("deflateSync")]),s._v("(store)\n\n  "),e("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 存储Git对象")]),s._v("\n  fs."),e("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("mkdirSync")]),s._v("("),e("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("`.git/objects/"),e("span",{pre:!0,attrs:{class:"hljs-subst"}},[s._v("${hash.substring("),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v(", "),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("2")]),s._v(")}")]),s._v("`")]),s._v(")\n  fs."),e("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("writeFileSync")]),s._v("("),e("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("`.git/objects/"),e("span",{pre:!0,attrs:{class:"hljs-subst"}},[s._v("${hash.substring("),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v(", "),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("2")]),s._v(")}")]),s._v("/"),e("span",{pre:!0,attrs:{class:"hljs-subst"}},[s._v("${hash.substring("),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("2")]),s._v(", "),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("40")]),s._v(")}")]),s._v("`")]),s._v(", zlib_store)\n\n  "),e("span",{pre:!0,attrs:{class:"hljs-variable language_"}},[s._v("console")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("log")]),s._v("(hash)\n}\n\n"),e("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 调用入口")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("gitHashObject")]),s._v("(process."),e("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("argv")]),s._v("["),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("2")]),s._v("], process."),e("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("argv")]),s._v("["),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("3")]),s._v("])\n")])]),e("p",[s._v("最后，测试下能否正确存储 Git 对象：")]),e("pre",{pre:!0},[e("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[s._v("$ node index.js "),e("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'hello, world'")]),s._v(" blob\n8c01d89ae06311834ee4b1fab2f0414d35f01102\n\n$ git cat-file -p 8c01d89ae06311834ee4b1fab2f0414d35f01102\nhello, world\n")])]),e("p",[s._v("由此可见，我们生成了一个合法的 Git 数据对象，证明算法是正确的。")]),e("p",[e("a",{attrs:{href:"https://jingsam.github.io/2018/06/15/git-storage.html"}},[s._v("阅读原文")])])])])])}],!1,null,null,null);t.default=r.exports}}]);